<html>
    <head>

        <title>Measuring Polyphony</title>
        <link href="favicon.ico" rel="icon" type="image/x-icon" />
          <!-- Custom fonts for this template -->
        <link href="https://fonts.googleapis.com/css?family=Arima+Madurai" rel="stylesheet">
        <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Cabin:700' rel='stylesheet' type='text/css'>
        <!-- Custom styles for this template -->
        <!-- A stylesheet for the help overlay -->
        <!--/////////////-->
        <!-- MIDI Player -->
        <!--/////////////-->
          <link rel="stylesheet" href="{{ site.baseurl }}css/midiplayer.css" />
          <link rel="stylesheet" href="{{ site.baseurl }}css/diva.min.css" />
        <link rel="stylesheet" href="{{ site.baseurl }}css/grayscale.css" />
          <!-- Bootstrap core CSS -->
    <link href="{{ site.baseurl }}vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

        <script src="http://www.verovio.org/javascript/develop/verovio-toolkit.js" type="text/javascript" ></script>
        <!-- We also use jQuery -->
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript" ></script>
        <!-- Basic events from example 02 -->
        <script src="{{ site.baseurl }}javascript/basic-events.js" type="text/javascript" ></script>

        <script type="text/javascript" language="javascript" src="{{ site.baseurl }}javascript/midi-player/wildwebmidi.js"></script>
        <script type="text/javascript" language="javascript" src="{{ site.baseurl }}javascript/midi-player/midiplayer.js"></script>
        <script src="{{ site.baseurl }}js/diva.min.js" type="text/javascript"></script>
    </head>
  <body id="page-top">
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav"  style="background-color:#5e0202; filter: drop-shadow(5px 5px 4px black);">
        <div class="container" style="font-family: 'Arima Madurai' !important;  filter: drop-shadow(5px 5px 4px black);">
          <img src="thumbnail.gif" alt="Mountain View" style="padding-right:15px;">
        <a class="navbar-brand js-scroll-trigger" href="{{ site.baseurl }}">Measuring Polyphony</a>

        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="{{ site.baseurl }}transcriptions.html">Transcriptions</a>
            </li>

          </ul>
        </div>
      </div>
    </nav>
    <header class="masthead" style=" padding-top:30px;">
      <div class="intro-body" style=" padding:10px;">
        <div class="container-fluid" style="background-color:#5e0202; height:80vh; width:180vh;border: 1px solid black;">
            <div class="row" style="color:black;overflow-wrap:normal;background-color:white; ">
              <div class="col-lg-8" style="text-align:right;">
              <p>Press <b>p</b> to start playing</p>
            <!--  <p>Previous editions</p>
              <p>Downloads</p>
              <p class="intro-text" id="iiif"></p> -->
</div>
            <div id="player" class="col-lg-4" style="text-align:right;"> </div>

</div>
<div class="row" style="color:white;overflow-wrap:normal; background-color:white;">
                <!-- The div where we are going to insert the SVG -->
              <div id="svg_output" style="background-color:white; margin:40px;    overflow-x: auto;
            white-space: nowrap;">


                  <!--<a class="page-link" href="{{ site.baseurl }}fullscreen.html?{{ site.baseu }}{{ xml.path }}">Fullscreen</a>-->
              </a>
              </div>
            </div>
<div class="row">
  <div class="col" style="font-family: 'Arima Madurai'; filter: drop-shadow(5px 5px 4px black); padding-top:15px;">
<p class="intro-text" id="iiif"></p>
              <h1  id="title"></h1>
              <p id="composer"></p><br>
              <div id="diva-wrapper" style="height:10px !important;"></div>
            </div>

</div>


            <div class="row" style="color:white;overflow-wrap:normal;">

<div class="col-lg-6 text-center"  >
  <b>Primary manuscript source for this transcription</b><br>
  <p id="primarysource"></p>
  <p id="diammlink"></p>
              <p id="concsources"></p><br>
<p id="prevedition"></p><br>

              </div>
              <div class="col-lg-6 text-center" >
                <b>Downloads</b><br>
                <ul class="text-left" style="display:inline-block;vertical-align:middle;">
                <li id="mei"></li>
                <li id="mens"></li>
                <li id="pdf"></li>
              </ul>

            </div>
            </div>
</div>

</div>
      </div>


  <script type="text/javascript">
var qs = parent.document.URL.substring(parent.document.URL.indexOf('?')+1, parent.document.URL.length);
var objectURL = "";
      /* Load the file using HTTP GET */
      $.get( qs, function( dataType ) {
      //  alert( "Data Loaded: " + dataType );
      $meiarray = qs.split("/")
      for (i = 0; i < $meiarray.length; i++) {
        if (i==($meiarray.length-1)){
           $meiarray[i] = $meiarray[i].replace("_MENSURAL", "");
        } else if ($meiarray[i]=="mensural") {
          $meiarray[i]="mei";
        }
      }
      $mei = $meiarray.join("/");
        xmlDoc = $.parseXML( dataType ),
        $xml = $( xmlDoc ),
        $title = $xml.find( "title" ).first();
          $composer = $xml.find( "composer" ).first();
            $primesource = $xml.find( "identifier" ).first();
            $concsources = $xml.find( "annot");
            $link = $xml.find( "item");
            $parts = $xml.find( "incipText");
            $quadruplum="";
            $contratenor="";
            $triplum="";
            $motetus="";
            $tenor="";
            objectURL = $link[0].attributes[1].textContent;
            if ($parts!=null){

            for (i = 0; i < $parts.length; i++) {
              if ($parts[i].attributes[0].textContent=="triplum"){
                  $triplum= $parts[i].textContent + "/";
              } else if ($parts[i].attributes[0].textContent=="motetus"){
                  $motetus= $parts[i].textContent;
              } else if ($parts[i].attributes[0].textContent=="tenor"){
                  $tenor= "/" + $parts[i].textContent;
              } else if ($parts[i].attributes[0].textContent=="contratenor"){
                  $contratenor= "/" + $parts[i].textContent;
              }else if ($parts[i].attributes[0].textContent=="quadruplum"){
                  $quadruplum= $parts[i].textContent + "/";
              }
            }
          }
          $("#title").html($triplum + $motetus +  $tenor + $contratenor);
            $("#composer").html($composer.text());
              $("#primarysource").html($primesource.text() + ", fol(s)." + $link[0].attributes[2].textContent);
                $("#diammlink").html( "<a href=\"" + $link[2].attributes[1].textContent + "\n\">Detailed information on this manuscript source</a>");
                $("#mens").html("<a href=\"" + qs + "\" download>MENSURAL</a>" );
                $("#mei").html("<a href=\"" + $mei + "\" download>MEI</a>" );
                  $("#pdf").html("<a href=\"" + $mei + "\" download>PDF</a>" );
                  loadDiva(objectURL);
                if (!$concsources[2].textContent.equals("")){
                $("#concsources").html("Concordant sources:" + $concsources[2].textContent);
              }


                //

      }, 'text');

      function loadDiva(objectURL) {
          $('#diva-wrapper').diva({
              enableAutoHeight: true,
              fixedHeightGrid: false,
              iipServerURL: "http://diva.simssa.ca/fcgi-bin/iipsrv.fcgi",
              objectData: objectURL,
              enableCanvas: true,
              enableDownload: true
          });
      }
  </script>
        <script type="text/javascript">
        var vrvToolkit = new verovio.toolkit();
        var page = 1;
        var zoom = 40;
        var pageHeight = 2970;
        var pageWidth = 2100;

            ////////////////////////////////////////////////
            /* A variable for storing the highlighted ids */
            ////////////////////////////////////////////////
            var ids = [];
            var isPlaying = false;

            function setOptions() {
              pageHeight = $(document).height() * 30 / zoom ;
              pageWidth = $(document).width() * 80 / zoom ;
              border = 20;
                options = {
                            inputFormat: 'mei',
                            pageHeight: pageHeight,
                            pageWidth: pageWidth,

                            border: border,
                            scale: zoom,

                            ignoreLayout: 1
                        };
                vrvToolkit.setOptions(options);
            }

            function loadData(data) {
                setOptions();
                vrvToolkit.loadData(data);

                page = 1;
                loadPage();
            }

            function loadPage() {
                svg = vrvToolkit.renderPage(page, {});
                $("#svg_output").html(svg);

                ////////////////////////////////////////
                /* Bind a on click event to each note */
                ////////////////////////////////////////
                $(".note").click(function() {
                    var id = $(this).attr("id");
                    var time = vrvToolkit.getTimeForElement(id);
                    // bug! time needs to be divided by 2
                    $("#midi-player").midiPlayer.seek(time / 2 );
                });
            };

            function loadFile() {
              //file="/mei/Beethoven_Sonata_no.29_op.106.mei";
                file = parent.document.URL.substring(parent.document.URL.indexOf('?')+1, parent.document.URL.length);;
                $.ajax({
                    url: file
                    , dataType: "text"
                    , success: function(data) {
                        loadData(data);
                    }
                });
            }

            ////////////////////////////////////////////
            /* A function that start playing the file */
            ////////////////////////////////////////////
            function play_midi() {
                if (isPlaying == false) {
                    var base64midi = vrvToolkit.renderToMidi();
                    var song = 'data:audio/midi;base64,' + base64midi;
                    $("#player").show();
                    $("#player").midiPlayer.play(song);
                    isPlaying = true;
                }
            }

            //////////////////////////////////////////////////////
            /* Two callback functions passed to the MIDI player */
            //////////////////////////////////////////////////////
            var midiUpdate = function(time) {
                // bug! time needs to be * 2 (- 800 for adjustment)
                var vrvTime = Math.max(0, time - 200);
                var elementsattime = vrvToolkit.getElementsAtTime(vrvTime);
                if (elementsattime.page > 0) {
                    if (elementsattime.page != page) {
                        page = elementsattime.page;
                        loadPage();
                    }
                    if ((elementsattime.notes.length > 0) && (ids != elementsattime.notes)) {
                        ids.forEach(function(noteid) {
                            if ($.inArray(noteid, elementsattime.notes) == -1) {
                                $("#" + noteid).attr("fill", "#000").attr("stroke", "#000");
                            }
                        });
                        ids = elementsattime.notes;
                        ids.forEach(function(noteid) {
                            if ($.inArray(noteid, elementsattime.notes) != -1) {
                                $("#" + noteid).attr("fill", "#c00").attr("stroke", "#c00");;
                            }
                        });
                    }
                }
            }

            var midiStop = function() {
                ids.forEach(function(noteid) {
                    $("#" + noteid).attr("fill", "#000").attr("stroke", "#000");
                });
                $("#player").hide();
                isPlaying = false;
            }

            $(document).ready(function() {

                $(window).keyup(function(event){
                    ////////////////////////////////
                    /* Key events 'p' for playing */
                    ////////////////////////////////
                    if (event.keyCode == 80) {
                        play_midi();
                    }
                });

                $(window).resize(function(){
                    applyZoom();
                });

                $("#player").midiPlayer({
                    color: "#c00",
                    onUnpdate: midiUpdate,
                    onStop: midiStop,
                    width: 250
                });

                loadFile();
            });
        </script>
        <script type="text/javascript">

                  </script>
</html>
