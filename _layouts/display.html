<html>
    <head>

        <title>Measuring Polyphony</title>
        <link href="favicon.ico" rel="icon" type="image/x-icon" />
        <script src="http://www.verovio.org/javascript/develop/verovio-toolkit.js" type="text/javascript" ></script>
        <!-- We also use jQuery -->
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript" ></script>
        <!-- Basic events from example 02 -->
        <script src="{{ site.baseurl }}javascript/basic-events.js" type="text/javascript" ></script>
        <!-- A stylesheet for the help overlay -->

        <!--/////////////-->
        <!-- MIDI Player -->
        <!--/////////////-->
        <script type="text/javascript" language="javascript" src="{{ site.baseurl }}javascript/midi-player/wildwebmidi.js"></script>
        <script type="text/javascript" language="javascript" src="{{ site.baseurl }}javascript/midi-player/midiplayer.js"></script>

        <!-- Bootstrap core CSS -->

        <!-- Custom fonts for this template -->
        <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Cabin:700' rel='stylesheet' type='text/css'>

        <!-- Custom styles for this template -->
          <link rel="stylesheet" href="{{ site.baseurl }}css/midiplayer.css" />
        <link rel="stylesheet" href="{{ site.baseurl }}css/grayscale.css" />
    <link href="{{ site.baseurl }}vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    </head>
  <body id="page-top">
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="{{ site.baseurl }}">Measuring Polyphony</a>

        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="{{ site.baseurl }}transcriptions.html">Transcriptions</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <header class="masthead">



      <div class="intro-body">
        <div class="container">
          <div class="row">
            <div id="svg_output" style="background-color:white; margin:40px;    overflow-x: auto;
                white-space: nowrap;">
                <!-- The div where we are going to insert the SVG -->
                <!--<a class="page-link" href="{{ site.baseurl }}fullscreen.html?{{ site.baseu }}{{ xml.path }}">Fullscreen</a>-->
            </a>
            </div>
            <div class="col-lg-8 mx-auto">
              <h1  id="title"></h1>
              <p id="composer"></p>
              <p>Primary manuscript source for this transcription</p>
              <p id="primarysource"></p>
              <p id="diammlink"></p>

              <p id="concsources"></p>
                <p>Downloads</p>
                <p id="mei"></p>
                <p id="mens"></p>
                <p>PDF</p>
              <p>Press <b>p</b> to start playing</p>
            <!--  <p>Previous editions</p>
              <p>Downloads</p>
              <p class="intro-text" id="iiif"></p> -->

<div id="player" class="col" style="padding-left:140px;"> </div>

              </div>
            </div>


</div>
<div class="col-fluid">

    <!-- A help overlay -->


    <!--//////////////////////////////////////////////////////-->
    <!-- The div where we are going to insert the MIDI Player -->
    <!--//////////////////////////////////////////////////////-->





</div>
      </div>



    </div>
  </div>



  </div>

  <script type="text/javascript">
var qs = parent.document.URL.substring(parent.document.URL.indexOf('?')+1, parent.document.URL.length);
      /* Load the file using HTTP GET */
      $.get( qs, function( dataType ) {
      //  alert( "Data Loaded: " + dataType );
      $meiarray = qs.split("/")
      for (i = 0; i < $meiarray.length; i++) {
        if (i==($meiarray.length-1)){
           $meiarray[i] = $meiarray[i].replace("_MENSURAL", "");
        } else if ($meiarray[i]=="mensural") {
          $meiarray[i]="mei";
        }
      }
      $mei = $meiarray.join("/");
        xmlDoc = $.parseXML( dataType ),
        $xml = $( xmlDoc ),
        $title = $xml.find( "title" ).first();
          $composer = $xml.find( "composer" ).first();
            $primesource = $xml.find( "identifier" ).first();
            $concsources = $xml.find( "annot");
            $link = $xml.find( "item");
            $parts = $xml.find( "incipText");
            $quadruplum="";
            $contratenor="";
            $triplum="";
            $motetus="";
            $tenor="";
            if ($parts!=null){

            for (i = 0; i < $parts.length; i++) {
              if ($parts[i].attributes[0].textContent=="triplum"){
                  $triplum= $parts[i].textContent + "/";
              } else if ($parts[i].attributes[0].textContent=="motetus"){
                  $motetus= $parts[i].textContent;
              } else if ($parts[i].attributes[0].textContent=="tenor"){
                  $tenor= "/" + $parts[i].textContent;
              } else if ($parts[i].attributes[0].textContent=="contratenor"){
                  $contratenor= "/" + $parts[i].textContent;
              }else if ($parts[i].attributes[0].textContent=="quadruplum"){
                  $quadruplum= $parts[i].textContent + "/";
              }
            }
          }
          $("#title").html($triplum + $motetus +  $tenor + $contratenor);
            $("#composer").html($composer.text());
              $("#primarysource").html($primesource.text() + ", fol(s)." + $link[0].attributes[2].textContent);
                $("#diammlink").html( "<a href=\"" + $link[2].attributes[1].textContent + "\n\">Detailed information on this manuscript source</a>");
                $("#concsources").html("Concordant sources:" + $concsources[2]);
                $("#mens").html("<a href=\"" + qs + "\" download>Mensural</a>" );
                $("#mei").html("<a href=\"" + $mei + "\" download>Mei</a>" );
                //$("#iiif").html($link[0].attributes[0].textContent + ": " +  $link[0].attributes[1].textContent);
      }, 'text');
  </script>
        <script type="text/javascript">
        var vrvToolkit = new verovio.toolkit();
        var page = 1;
        var zoom = 40;
        var pageHeight = 2970;
        var pageWidth = 2100;

            ////////////////////////////////////////////////
            /* A variable for storing the highlighted ids */
            ////////////////////////////////////////////////
            var ids = [];
            var isPlaying = false;

            function setOptions() {
              pageHeight = $(document).height() * 30 / zoom ;
              pageWidth = $(document).width() * 80 / zoom ;
              border = 20;
                options = {
                            inputFormat: 'mei',
                            pageHeight: pageHeight,
                            pageWidth: pageWidth,

                            border: border,
                            scale: zoom,

                            ignoreLayout: 1
                        };
                vrvToolkit.setOptions(options);
            }

            function loadData(data) {
                setOptions();
                vrvToolkit.loadData(data);

                page = 1;
                loadPage();
            }

            function loadPage() {
                svg = vrvToolkit.renderPage(page, {});
                $("#svg_output").html(svg);

                ////////////////////////////////////////
                /* Bind a on click event to each note */
                ////////////////////////////////////////
                $(".note").click(function() {
                    var id = $(this).attr("id");
                    var time = vrvToolkit.getTimeForElement(id);
                    // bug! time needs to be divided by 2
                    $("#midi-player").midiPlayer.seek(time / 2 );
                });
            };

            function loadFile() {
              //file="/mei/Beethoven_Sonata_no.29_op.106.mei";
                file = parent.document.URL.substring(parent.document.URL.indexOf('?')+1, parent.document.URL.length);;
                $.ajax({
                    url: file
                    , dataType: "text"
                    , success: function(data) {
                        loadData(data);
                    }
                });
            }

            ////////////////////////////////////////////
            /* A function that start playing the file */
            ////////////////////////////////////////////
            function play_midi() {
                if (isPlaying == false) {
                    var base64midi = vrvToolkit.renderToMidi();
                    var song = 'data:audio/midi;base64,' + base64midi;
                    $("#player").show();
                    $("#player").midiPlayer.play(song);
                    isPlaying = true;
                }
            }

            //////////////////////////////////////////////////////
            /* Two callback functions passed to the MIDI player */
            //////////////////////////////////////////////////////
            var midiUpdate = function(time) {
                // bug! time needs to be * 2 (- 800 for adjustment)
                var vrvTime = Math.max(0, time - 200);
                var elementsattime = vrvToolkit.getElementsAtTime(vrvTime);
                if (elementsattime.page > 0) {
                    if (elementsattime.page != page) {
                        page = elementsattime.page;
                        loadPage();
                    }
                    if ((elementsattime.notes.length > 0) && (ids != elementsattime.notes)) {
                        ids.forEach(function(noteid) {
                            if ($.inArray(noteid, elementsattime.notes) == -1) {
                                $("#" + noteid).attr("fill", "#000").attr("stroke", "#000");
                            }
                        });
                        ids = elementsattime.notes;
                        ids.forEach(function(noteid) {
                            if ($.inArray(noteid, elementsattime.notes) != -1) {
                                $("#" + noteid).attr("fill", "#c00").attr("stroke", "#c00");;
                            }
                        });
                    }
                }
            }

            var midiStop = function() {
                ids.forEach(function(noteid) {
                    $("#" + noteid).attr("fill", "#000").attr("stroke", "#000");
                });
                $("#player").hide();
                isPlaying = false;
            }

            $(document).ready(function() {

                $(window).keyup(function(event){
                    ////////////////////////////////
                    /* Key events 'p' for playing */
                    ////////////////////////////////
                    if (event.keyCode == 80) {
                        play_midi();
                    }
                });

                $(window).resize(function(){
                    applyZoom();
                });

                $("#player").midiPlayer({
                    color: "#c00",
                    onUnpdate: midiUpdate,
                    onStop: midiStop,
                    width: 250
                });

                loadFile();
            });
        </script>

</html>
