<html>

<head>

  <title>Measuring Polyphony</title>
  <link href="favicon.ico" rel="icon" type="image/x-icon" />
  <!-- Custom fonts for this template -->
  <link href="https://fonts.googleapis.com/css?family=Arima+Madurai" rel="stylesheet">
  <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href='https://fonts.googleapis.com/css?family=Cabin:700' rel='stylesheet' type='text/css'>
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <!-- A stylesheet for the help overlay -->
  <!--/////////////-->
  <!-- MIDI Player -->
  <!--/////////////-->
  <link rel="stylesheet" href="{{ site.baseurl }}css/midiplayer.css" />
  <link rel="stylesheet" href="{{ site.baseurl }}css/diva.min.css" />
  <link rel="stylesheet" href="{{ site.baseurl }}css/grayscale.css" />
  <!-- Bootstrap core CSS -->
  <link href="{{ site.baseurl }}vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="https://www.verovio.org/javascript/develop/verovio-toolkit.js" type="text/javascript"></script>
  <!-- We also use jQuery -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript"></script>
  <!-- Basic events from example 02 -->
  <script src="{{ site.baseurl }}javascript/basic-events.js" type="text/javascript"></script>

  <script type="text/javascript" language="javascript" src="{{ site.baseurl }}javascript/midi-player/wildwebmidi.js"></script>
  <script type="text/javascript" language="javascript" src="{{ site.baseurl }}javascript/midi-player/midiplayer.js"></script>
  <script src="{{ site.baseurl }}js/diva.min.js" type="text/javascript"></script>
</head>

<body id="page-top">
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav" style="background-color:#5e0202; filter: drop-shadow(5px 5px 4px black);">
    <div class="container" style="font-family: 'Arima Madurai' !important;  filter: drop-shadow(5px 5px 4px black);">
      <img src="thumbnail.gif" alt="Mountain View" style="padding-right:15px;">
      <a class="navbar-brand js-scroll-trigger" href="{{ site.baseurl }}">Measuring Polyphony</a>

      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="{{ site.baseurl }}transcriptions.html">Transcriptions</a>
          </li>

        </ul>
      </div>
    </div>
  </nav>
  <header class="masthead" style=" padding-top:150px;">
    <div class="intro-body" style=" padding:10px;">
      <div class="container-fluid" style="height:88vh; width:180vh;">
        <div class="row">
          <div class="col text-left" style="font-family: 'Arima Madurai';  padding-top:15px; color:white; background-color:#5e0202;border-top: 1px solid black; border-left: 1px solid black;border-right: 1px solid black;">
            <p class="intro-text" id="iiif"></p>
            <h1 id="title"></h1>
            <p id="composer"></p><br>

          </div>

        </div>
        <div class="row" style="color:black;overflow-wrap:normal;background-color:white;background-color:#5e0202; text-align:center;">
          <div class="col-lg-4" style="text-align:right;">

        <div id="player" style="text-align:right;"> </div>

        </div>
<div class="col-lg-4 text-center">
                      <button type="button" class="btn btn-default btn-lg" onclick="flipPageBackward();" style="color: white;"> <span class="glyphicon glyphicon-arrow-left"></span></button>
<input id="flipDisplay" type="button" value="Display Mensural" onclick="loadMei();" style="text-align:right; background-color:transparent; color:white; border:transparent;" />
                      <button type="button" class="btn btn-default btn-lg" onclick="flipPageForward();" style="color: white;"><span class="glyphicon glyphicon-arrow-right"></span></button>
        </div>
        <div class="col-lg-4" style="text-align:right;">


        <button type="button" id = "setFullscreen" class="btn btn-default btn-lg" onclick="setFullscreen();" style="color: white;"> <span class="glyphicon glyphicon-resize-full"></span></button>

            <!--  <p>Previous editions</p>
              <p>Downloads</p>
              <p class="intro-text" id="iiif"></p> -->
          </div>
</div>

        <div class="row" id = "svg_row" style="overflow-wrap:normal; background-color:#5e0202; border: 1px solid black;">
          <div class="col text-center" style="height:50vh;">
          <!-- The div where we are going to insert the SVG -->
          <div id="svg_output" style="background-color:white; margin:40px;    overflow-x: auto;
            white-space: nowrap;">


            <!--<a class="page-link" href="{{ site.baseurl }}fullscreen.html?{{ site.baseu }}{{ xml.path }}">Fullscreen</a>-->
            </a>
          </div>
        </div>
      </div>

        <div class="row" style="overflow-wrap:normal;color:black; background-color:white; padding-top:10px; border: 1px solid black; height: 30vh;">
          <div class="col-lg-2 text-left">
              <a class="btn" data-toggle="modal" href="#myModal" onclick="loadDivaModal();">More Images</a>
            <div id="diva-wrapper"></div>

            <div class="modal fade" id="myModal" style="background-color:white;height:95vh; margin-top: 95px;">
              <!-- note the use of "hide" class -->
              <div class="modal-header" style="height:1vh;">
                <button class="close" data-dismiss="modal" style="font-size:40;">×</button>
              </div>
              <div id="diva-modal">
              </div>
            </div>​
          </div>
          <div class="col-lg-4 text-left" style:"padding-left:15px;">
            <h1><b>Primary manuscript source for this transcription</b></h1><br>
            <p id="primarysource"></p> <br>

            <p id="concsources"></p><br>
            <p id="prevedition"></p><br>
            <p id="diammlink"></p>

          </div>

          <div class="col-lg-4 text-left">
            <h1><b>Downloads</b></h1><br>

              <p id="mei"></p><br>
              <p id="mens"></p><br>
              <p id="pdf"></p>

            <!-- Button trigger modal -->

          </div>
        </div>
      </div>

    </div>
    </div>



    <script type="text/javascript">
      var qs = parent.document.URL.substring(parent.document.URL.indexOf('?') + 1, parent.document.URL.length);
      var manifest = {{ site.data.manifest | jsonify}};
      /* Load the file using HTTP GET */
      $.get(qs, function(dataType) {
        //  alert( "Data Loaded: " + dataType );
        $meiarray = qs.split("/")
        for (i = 0; i < $meiarray.length; i++) {
          if (i == ($meiarray.length - 1)) {
            $meiarray[i] = $meiarray[i].replace("_MENSURAL", "");
          } else if ($meiarray[i] == "mensural") {
            $meiarray[i] = "mei";
          }
          style = "height:10px !important;"
        }
        $mei = $meiarray.join("/");
        xmlDoc = $.parseXML(dataType),
          $xml = $(xmlDoc),
          $title = $xml.find("title").first();
        $composer = $xml.find("composer").first();
        $primesource = $xml.find("identifier").first();
        $concsources = $xml.find("annot");
        $link = $xml.find("item");
        $parts = $xml.find("incipText");
        $needle = $link[0].attributes[2].textContent.split(",")[0];
        $quadruplum = "";
        $contratenor = "";
        $triplum = "";
        $motetus = "";
        $tenor = "";
        for (var i = 0; i < manifest.sequences[0].canvases.length; i++) {
          // look for the entry with a matching `code` value
          if (manifest.sequences[0].canvases[i].label == $needle) {
            $pagelink = manifest.sequences[0].canvases[i].images[0].on;
            // we found it
            // obj[i].name is the matched result
          }
        }
        pagenum = $pagelink.split("/canvas/f")[1];
        if ($parts != null) {

          for (i = 0; i < $parts.length; i++) {
            if ($parts[i].attributes[0].textContent == "triplum") {
              $triplum = $parts[i].textContent + "/";
            } else if ($parts[i].attributes[0].textContent == "motetus") {
              $motetus = $parts[i].textContent;
            } else if ($parts[i].attributes[0].textContent == "tenor") {
              $tenor = "/" + $parts[i].textContent;
            } else if ($parts[i].attributes[0].textContent == "contratenor") {
              $contratenor = "/" + $parts[i].textContent;
            } else if ($parts[i].attributes[0].textContent == "quadruplum") {
              $quadruplum = $parts[i].textContent + "/";
            }
          }
        }
        $("#title").html($triplum + $motetus + $tenor + $contratenor);
        $("#composer").html($composer.text());
        $("#primarysource").html($primesource.text() + ", fol(s)." + $link[0].attributes[2].textContent);
        $("#diammlink").html("<a href=\"" + $link[3].attributes[1].textContent + "\n\">Detailed information on this manuscript source</a>");
        $("#mens").html("<a href=\"" + qs + "\" download>MENSURAL</a>");
        $("#mei").html("<a href=\"" + $mei + "\" download>MEI</a>");
        $("#pdf").html("<a href=\"" + $mei + "\" download>PDF</a>");



manifest = "http://gallica.bnf.fr/iiif/ark:/12148/btv1b8454675g/manifest.json";
          loadDiva(manifest, pagenum);

        if ($concsources[2] !== ("")) {
          $("#concsources").html("Concordant sources:" + $concsources[2].textContent);
        }



        //

      }, 'text');

      function loadDiva(manifest, pagenum) {
        $('#diva-wrapper').diva({
          enableAutoHeight: false,
          fixedHeightGrid: false,
          iipServerURL: "https://diva.simssa.ca/fcgi-bin/iipsrv.fcgi",
          objectData: manifest,
          enableCanvas: false,
          enableDownload: false,
          goDirectlyTo: pagenum, //INSERT PAGE HERE
          pagesPerRow: 1,
          maxPagesPerRow: 1,
          gridView: false,
          enableToolbar: false,
          zoomLevel: 0,
          enableAutoTitle: false,
          viewportMargin: 0,
          fixedPadding: 0,
          adaptivePadding: 0,
          verticalMiddleOfViewport: true
        });

        var diva = $('#diva-wrapper').data('diva');
        diva.disableScrollable();

        document.getElementById("1-diva-outer").style.height="238px";
document.getElementById("1-diva-inner").style.height="238px";
document.getElementById("1-diva-outer").style.width="165px";
document.getElementById("1-diva-inner").style.width="165px !important";
document.getElementById("1-diva-inner").style.margin="0px";

      }

        function loadDivaModal(){
          $('#diva-modal').diva({
            enableAutoHeight: true,
            fixedHeightGrid: false,
            iipServerURL: "https://diva.simssa.ca/fcgi-bin/iipsrv.fcgi",
            objectData: manifest ,
            enableCanvas: true,
            enableDownload: true,
            inBookLayout: true,
            goDirectlyTo: pagenum
          });
            document.getElementById("2-diva-outer").style.height="1000px";
        }
    </script>
    <script type="text/javascript">
      var vrvToolkit = new verovio.toolkit();
      var page = 1;
      var zoom = 40;
      var pageHeight = 2970;
      var pageWidth = 2100;

      ////////////////////////////////////////////////
      /* A variable for storing the highlighted ids */
      ////////////////////////////////////////////////
      var ids = [];
      var isPlaying = false;

      function setOptions() {
        pageHeight = $(document).height() * 30 / zoom;
        pageWidth = $(document).width() * 80 / zoom;
        border = 20;
        options = {
          inputFormat: 'mei',
          pageHeight: pageHeight,
          pageWidth: pageWidth,

          border: border,
          scale: zoom,

          ignoreLayout: 1
        };
        vrvToolkit.setOptions(options);
        document.getElementsByClassName("example");
      }

      function setFullscreen() {

        if (document.getElementById("setFullscreen").innerHTML ==" <span class=\"glyphicon glyphicon-resize-full\"></span>"){
        $.ajax({
          url: file,
          dataType: "text",
          success: function(data) {
            loadData(data);
          }
        });
        //expands size of div

        //new settings for zooming
        page = 1;
        zoom = 30;
        var pageHeight = 2970;
var pageWidth = 2100;
        pageHeight = $(window).height() * 100 / zoom;
        pageWidth = $(window).width() * 100 / zoom;
        border = 50;
        options = {
          inputFormat: 'mei',
          pageHeight: pageHeight,
          pageWidth: pageWidth,

          border: border,
          scale: zoom,
          adjustPageHeight: true,
          ignoreLayout: 1
        };
        //set new options
        vrvToolkit.setOptions(options);
        document.getElementById("setFullscreen").innerHTML =" <span class=\"glyphicon glyphicon-resize-small\"></span>";
          document.getElementById("svg_row").style.height = "2500px";
          setTimeout(function(){document.getElementById("svg_row").style.height = "800px"}, 10);
      } else{
        $.ajax({
          url: file,
          dataType: "text",
          success: function(data) {
            loadData(data);
          }
        });
        //expands size of div
        document.getElementById("svg_row").style.height = "";
        //new settings for zooming
        page = 1;
        zoom = 40;
        pageHeight = 2970;
        pageWidth = 2100;
        pageHeight = $(document).height() * 30 / zoom;
        pageWidth = $(document).width() * 80 / zoom;
        border = 50;
        options = {
          inputFormat: 'mei',
          pageHeight: pageHeight,
          pageWidth: pageWidth,

          border: border,
          scale: zoom,
          adjustPageHeight: 1,
          ignoreLayout: 1
        };
        //set new options
        vrvToolkit.setOptions(options);
        vrvToolkit.loadData(data);
        document.getElementById("setFullscreen").innerHTML =" <span class=\"glyphicon glyphicon-resize-full\"></span>";
      }



      }

      function flipPageForward() {
        page = page + 1;
        loadPage();
      }

      function flipPageBackward() {
        if (page != 1) {
          page = page - 1;
        }
        loadPage();
      }

      function loadData(data) {
        setOptions();
        vrvToolkit.loadData(data);

        page = 1;
        display_midi();
        loadPage();
      }

      function loadPage() {
        svg = vrvToolkit.renderPage(page, {});
        $("#svg_output").html(svg);

        ////////////////////////////////////////
        /* Bind a on click event to each note */
        ////////////////////////////////////////
        $(".note").click(function() {
          var id = $(this).attr("id");
          var time = vrvToolkit.getTimeForElement(id);
          // bug! time needs to be divided by 2
          $("#midi-player").midiPlayer.seek(time / 2);
        });
document.getElementsByClassName("pgHead")[0].remove();
      };

      function loadFile() {

        //file="/mei/Beethoven_Sonata_no.29_op.106.mei";
        file = parent.document.URL.substring(parent.document.URL.indexOf('?') + 1, parent.document.URL.length);;
        $meiarray = file.split("/")
        for (i = 0; i < $meiarray.length; i++) {
          if (i == ($meiarray.length - 1)) {
            $meiarray[i] = $meiarray[i].replace("_MENSURAL", "");
          } else if ($meiarray[i] == "mensural") {
            $meiarray[i] = "mei";
          }
          style = "height:10px !important;"
        }
        $mei = $meiarray.join("/");

        file = $mei;

        $.ajax({
          url: file,
          dataType: "text",
          success: function(data) {
            loadData(data);
          }
        });
      }

      function loadMei() {
        //file="/mei/Beethoven_Sonata_no.29_op.106.mei";
        if (document.getElementById("flipDisplay").value == "Display Mensural") {
          file = parent.document.URL.substring(parent.document.URL.indexOf('?') + 1, parent.document.URL.length);;
          $.ajax({
            url: file,
            dataType: "text",
            success: function(data) {
              loadData(data);
            }
          });
          document.getElementById("flipDisplay").value = "Display Mei";
        } else {
          file = parent.document.URL.substring(parent.document.URL.indexOf('?') + 1, parent.document.URL.length);;
          $meiarray = file.split("/")
          for (i = 0; i < $meiarray.length; i++) {
            if (i == ($meiarray.length - 1)) {
              $meiarray[i] = $meiarray[i].replace("_MENSURAL", "");
            } else if ($meiarray[i] == "mensural") {
              $meiarray[i] = "mei";
            }
            style = "height:10px !important;"
          }
          $mei = $meiarray.join("/");
          file = $mei;
          $.ajax({
            url: file,
            dataType: "text",
            success: function(data) {
              loadData(data);
            }
          });
          document.getElementById("flipDisplay").value = "Display Mensural";
        }
      }
      ////////////////////////////////////////////
      /* A function that start playing the file */
      ////////////////////////////////////////////
      function play_midi() {
        if (isPlaying == false) {
          var base64midi = vrvToolkit.renderToMIDI();
          var song = 'data:audio/midi;base64,' + base64midi;
          $("#player").show();
          $("#player").midiPlayer.play(song);
          isPlaying = true;
        }
      }

      function display_midi() {

          var base64midi = vrvToolkit.renderToMIDI();
          var song = 'data:audio/midi;base64,' + base64midi;
          display(song);

      }

      //////////////////////////////////////////////////////
      /* Two callback functions passed to the MIDI player */
      //////////////////////////////////////////////////////
      var midiUpdate = function(time) {
        // bug! time needs to be * 2 (- 800 for adjustment)
        var vrvTime = Math.max(0, time - 200);
        var elementsattime = vrvToolkit.getElementsAtTime(vrvTime);
        if (elementsattime.page > 0) {
          if (elementsattime.page != page) {
            page = elementsattime.page;
            loadPage();
          }
          if ((elementsattime.notes.length > 0) && (ids != elementsattime.notes)) {
            ids.forEach(function(noteid) {
              if ($.inArray(noteid, elementsattime.notes) == -1) {
                $("#" + noteid).attr("fill", "#000").attr("stroke", "#000");
              }
            });
            ids = elementsattime.notes;
            ids.forEach(function(noteid) {
              if ($.inArray(noteid, elementsattime.notes) != -1) {
                $("#" + noteid).attr("fill", "#c00").attr("stroke", "#c00");;
              }
            });
          }
        }
      }


      var midiStop = function() {
        ids.forEach(function(noteid) {
          $("#" + noteid).attr("fill", "#000").attr("stroke", "#000");
        });
        $("#player").hide();
        isPlaying = false;
      }

      $(document).ready(function() {

        $(window).keyup(function(event) {
          ////////////////////////////////
          /* Key events 'p' for playing */
          ////////////////////////////////
          if (event.keyCode == 80) {
            display_midi();
          }
        });

        $(window).resize(function() {
          applyZoom();
        });

        $("#player").midiPlayer({
          color: "#c00",
          onUnpdate: midiUpdate,
          onStop: midiStop,
          width: 250
        });
        document.getElementById("midiPlayer_div").style.color="white";

        document.getElementById("midiPlayer_div").style.backgroundColor="#5e0202";
        loadFile();


      });
    </script>
    <script type="text/javascript">
    </script>

</html>
